(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","Slick","nf.Common","nf.Client","nf.ErrorHandler"],function(d,g,e,c,f){return(nf.UsersTable=b(d,g,e,c,f))})}else{if(typeof exports==="object"&&typeof module==="object"){module.exports=(nf.UsersTable=b(require("jquery"),require("Slick"),require("nf.Common"),require("nf.Client"),require("nf.ErrorHandler")))}else{nf.UsersTable=b(a.$,a.Slick,a.nf.Common,a.nf.Client,a.nf.ErrorHandler)}}}(this,function(w,b,F,m,e){var u=false;var C={urls:{users:"../nifi-api/tenants/users",userGroups:"../nifi-api/tenants/user-groups"}};var B=function(){w("#user-delete-dialog").modal({headerText:"Delete Account",buttons:[{buttonText:"Delete",color:{base:"#728E9B",hover:"#004849",text:"#ffffff"},handler:{click:function(){var M=w("#user-id-delete-dialog").val();var N=w("#users-table").data("gridInstance");var O=N.getData();var K=O.getItemById(M);var L=m.getRevision(K);w.ajax({type:"DELETE",url:K.uri+"?"+w.param(w.extend({disconnectedNodeAcknowledged:u},L)),dataType:"json"}).done(function(){l.loadUsersTable()}).fail(e.handleAjaxError);w("#user-delete-dialog").modal("hide")}}},{buttonText:"Cancel",color:{base:"#E3E8EB",hover:"#C7D2D7",text:"#004849"},handler:{click:function(){w("#user-delete-dialog").modal("hide")}}}],handler:{close:function(){w("#user-id-delete-dialog").val("");w("#user-name-delete-dialog").text("")}}})};var A=function(){var K=[];w("#available-groups div.group-check").filter(function(){return w(this).hasClass("checkbox-checked")}).each(function(){var L=w(this).next("span.group-id").text();K.push({id:L})});return K};var c=function(){var K=[];w("#available-users div.user-check").filter(function(){return w(this).hasClass("checkbox-checked")}).each(function(){var L=w(this).next("span.user-id").text();K.push({id:L})});return K};var s=function(M,L){var K=[];w.each(M.component.users,function(O,P){K.push({id:P.id})});K.push({id:L.id});var N={revision:m.getRevision(M),disconnectedNodeAcknowledged:u,component:w.extend({},M.component,{users:K})};return w.ajax({type:"PUT",url:M.uri,data:JSON.stringify(N),dataType:"json",contentType:"application/json"})};var o=function(M,L){var K=[];w.each(M.component.users,function(O,P){if(P.id!==L.id){K.push({id:P.id})}});var N={revision:m.getRevision(M),disconnectedNodeAcknowledged:u,component:w.extend({},M.component,{users:K})};return w.ajax({type:"PUT",url:M.uri,data:JSON.stringify(N),dataType:"json",contentType:"application/json"})};var H=function(L,K){var N=w("#users-table").data("gridInstance");var O=N.getData();var M=w.ajax({type:"POST",url:C.urls.users,data:JSON.stringify(L),dataType:"json",contentType:"application/json"});M.done(function(P){w("#user-dialog").modal("hide");var Q=[];w.each(K,function(R,S){var T=O.getItemById(S.id);Q.push(s(T,P))});w.when.apply(window,Q).always(function(){l.loadUsersTable().done(function(){var R=O.getRowById(P.id);N.setSelectedRows([R]);N.scrollRowIntoView(R)})}).fail(e.handleAjaxError)}).fail(e.handleConfigurationUpdateAjaxError)};var D=function(O,N,K){var P=w("#users-table").data("gridInstance");var R=P.getData();var M=R.getItemById(O);var Q={revision:m.getRevision(M),disconnectedNodeAcknowledged:u,component:{id:O,identity:N}};var L=w.ajax({type:"PUT",url:M.uri,data:JSON.stringify(Q),dataType:"json",contentType:"application/json"});L.done(function(V){w("#user-dialog").modal("hide");var S=[];var T=[];w.each(V.component.userGroups,function(X,Y){var W=w.grep(K,function(Z){return Z.id===Y.id});if(W.length===0){T.push(Y)}});w.each(K,function(X,Y){var W=w.grep(V.component.userGroups,function(Z){return Z.id===Y.id});if(W.length===0){S.push(Y)}});var U=[];w.each(S,function(W,Y){var X=R.getItemById(Y.id);U.push(s(X,V))});w.each(T,function(W,Y){var X=R.getItemById(Y.id);U.push(o(X,V))});w.when.apply(window,U).always(function(){l.loadUsersTable()}).fail(e.handleAjaxError)}).fail(e.handleConfigurationUpdateAjaxError)};var d=function(K){w.ajax({type:"POST",url:C.urls.userGroups,data:JSON.stringify(K),dataType:"json",contentType:"application/json"}).done(function(L){w("#user-dialog").modal("hide");l.loadUsersTable().done(function(){var M=w("#users-table").data("gridInstance");var N=M.getData();var O=N.getRowById(L.id);M.setSelectedRows([O]);M.scrollRowIntoView(O)})}).fail(e.handleConfigurationUpdateAjaxError)};var i=function(L,K,O){var M=w("#users-table").data("gridInstance");var P=M.getData();var N=P.getItemById(L);var Q={revision:m.getRevision(N),disconnectedNodeAcknowledged:u,component:{id:L,identity:K,users:O}};w.ajax({type:"PUT",url:N.uri,data:JSON.stringify(Q),dataType:"json",contentType:"application/json"}).done(function(R){w("#user-dialog").modal("hide");l.loadUsersTable()}).fail(e.handleConfigurationUpdateAjaxError)};var h=function(){w("#user-dialog").modal({headerText:"User/Group",buttons:[{buttonText:"Ok",color:{base:"#728E9B",hover:"#004849",text:"#ffffff"},handler:{click:function(){var M=w("#user-id-edit-dialog").text();var L=w("#user-identity-edit-dialog").val();if(w.trim(M)===""){var K={revision:m.getRevision({revision:{version:0}}),disconnectedNodeAcknowledged:u};if(w("#individual-radio-button").is(":checked")){K.component={identity:L};H(K,A())}else{K.component={identity:L,users:c()};d(K)}}else{if(w("#individual-radio-button").is(":checked")){D(M,L,A())}else{i(M,L,c())}}}}},{buttonText:"Cancel",color:{base:"#E3E8EB",hover:"#C7D2D7",text:"#004849"},handler:{click:function(){w("#user-dialog").modal("hide")}}}],handler:{close:function(){w('#user-dialog input[name="userOrGroup"]').attr("disabled",false);w("#individual-radio-button").prop("checked",true);w("#user-groups").show();w("#group-members").hide();w("#user-id-edit-dialog").text("");w("#user-identity-edit-dialog").val("");w("#available-users").empty();w("#available-groups").empty()}}});w('#user-dialog input[name="userOrGroup"]').on("change",function(){if(w(this).val()==="individual"){w("#user-groups").show();w("#group-members").hide()}else{w("#user-groups").hide();w("#group-members").show()}})};var r=function(){w("#user-policies-dialog").modal({headerText:"User Policies",buttons:[{buttonText:"Close",color:{base:"#728E9B",hover:"#004849",text:"#ffffff"},handler:{click:function(){w("#user-policies-dialog").modal("hide")}}}]})};var I=function(K){return"Global policy to "+K.text};var n=function(K){return'<span class="unset">Unknown resource '+F.escapeHtml(K.component.resource)+"</span>"};var E=function(K){var M=K.component.resource;if(M==="/restricted-components"){return"Restricted components regardless of restrictions"}var L=F.substringAfterFirst(M,"/restricted-components/");return"Restricted components requiring '"+F.escapeHtml(L)+"'"};var J=function(K){var M=K.component.resource;var L="";if(M.startsWith("/policies")){M=F.substringAfterFirst(M,"/policies");L+="Admin policy for "}else{if(M.startsWith("/data-transfer")){M=F.substringAfterFirst(M,"/data-transfer");L+="Site to site policy for "}else{if(M.startsWith("/data")){M=F.substringAfterFirst(M,"/data");L+="Data policy for "}else{if(M.startsWith("/operation")){M=F.substringAfterFirst(M,"/operation");L+="Operate policy for "}else{L+="Component policy for "}}}}if(M.startsWith("/processors")){L+="processor "}else{if(M.startsWith("/controller-services")){L+="controller service "}else{if(M.startsWith("/funnels")){L+="funnel "}else{if(M.startsWith("/input-ports")){L+="input port "}else{if(M.startsWith("/labels")){L+="label "}else{if(M.startsWith("/output-ports")){L+="output port "}else{if(M.startsWith("/process-groups")){L+="process group "}else{if(M.startsWith("/remote-process-groups")){L+="remote process group "}else{if(M.startsWith("/reporting-tasks")){L+="reporting task "}else{if(M.startsWith("/templates")){L+="template "}else{if(M.startsWith("/parameter-contexts")){L+="parameter context "}}}}}}}}}}}if(K.component.componentReference.permissions.canRead===true){L+='<span style="font-weight: 500">'+F.escapeHtml(K.component.componentReference.component.name)+"</span>"}else{L+='<span class="unset">'+F.escapeHtml(K.component.componentReference.id)+"</span>"}return L};var t=function(){var M=function(V,S,U,T,R){if(R.permissions.canRead===true){return G(R)}else{return'<span class="unset">'+F.escapeHtml(R.id)+"</span>"}};var P=function(W,S,V,U,R){var T="";if(R.permissions.canRead===true){if(F.isDefinedAndNotNull(R.component.componentReference)){if(R.component.resource.indexOf("/processors")>=0){T+='<div title="Go To" class="pointer go-to-component fa fa-long-arrow-right" style="float: left;"></div>'}else{if(R.component.resource.indexOf("/controller-services")>=0){}else{if(R.component.resource.indexOf("/funnels")>=0){T+='<div title="Go To" class="pointer go-to-component fa fa-long-arrow-right" style="float: left;"></div>'}else{if(R.component.resource.indexOf("/input-ports")>=0){T+='<div title="Go To" class="pointer go-to-component fa fa-long-arrow-right" style="float: left;"></div>'}else{if(R.component.resource.indexOf("/labels")>=0){T+='<div title="Go To" class="pointer go-to-component fa fa-long-arrow-right" style="float: left;"></div>'}else{if(R.component.resource.indexOf("/output-ports")>=0){T+='<div title="Go To" class="pointer go-to-component fa fa-long-arrow-right" style="float: left;"></div>'}else{if(R.component.resource.indexOf("/process-groups")>=0){T+='<div title="Go To" class="pointer go-to-process-group fa fa-long-arrow-right" style="float: left;"></div>'}else{if(R.component.resource.indexOf("/remote-process-groups")>=0){T+='<div title="Go To" class="pointer go-to-component fa fa-long-arrow-right" style="float: left;"></div>'}else{if(R.component.resource.indexOf("/reporting-tasks")>=0){}else{if(R.component.resource.indexOf("/templates")>=0){}else{if(R.component.resource.indexOf("/parameter-contexts")>=0){T+='<div title="Go To" class="pointer go-to-parameter-context fa fa-long-arrow-right" style="float: left;"></div>'}}}}}}}}}}}}}return T};var O=function(W,S,V,U,R){var T="";if(R.permissions.canRead===true){T+=R.component.action}return F.escapeHtml(T)};var L=[{id:"policy",name:"Policy",sortable:true,resizable:true,formatter:M,width:150},{id:"action",name:"Action",sortable:true,resizable:false,formatter:O,width:50}];if(top!==window){L.push({id:"actions",name:"&nbsp;",sortable:false,resizable:false,formatter:P,width:25})}var K={forceFitColumns:true,enableTextSelectionOnCells:true,enableCellNavigation:true,enableColumnReorder:false,autoEdit:false};var Q=new b.Data.DataView({inlineFilters:false});Q.setItems([]);v({columnId:"policy",sortAsc:true},Q);var N=new b.Grid("#user-policies-table",Q,L,K);N.setSelectionModel(new b.RowSelectionModel());N.registerPlugin(new b.AutoTooltips());N.setSortColumn("policy",true);N.onSort.subscribe(function(S,R){v({columnId:R.sortCol.id,sortAsc:R.sortAsc},Q)});N.onClick.subscribe(function(U,R){var T=w(U.target);var S=Q.getItem(R.row);if(N.getColumns()[R.cell].id==="actions"){if(T.hasClass("go-to-component")){parent.$("body").trigger("GoTo:Component",{id:S.component.componentReference.id,parentGroupId:S.component.componentReference.parentGroupId});parent.$("#shell-close-button").click()}else{if(T.hasClass("go-to-process-group")){parent.$("body").trigger("GoTo:ProcessGroup",{id:S.component.componentReference.id});parent.$("#shell-close-button").click()}else{if(T.hasClass("go-to-parameter-context")){parent.$("body").trigger("GoTo:ParameterContext",{id:S.component.componentReference.id});parent.$("#shell-close-button").click()}}}}});Q.onRowCountChanged.subscribe(function(S,R){N.updateRowCount();N.render()});Q.onRowsChanged.subscribe(function(S,R){N.invalidateRows(R.rows);N.render()});w("#user-policies-table").data("gridInstance",N)};var q=function(L){w("#users-filter").keyup(function(){p()});w("#users-filter-type").combo({options:[{text:"by user",value:"identity"}],select:function(S){p()}});var K=function(X,T,W,V,S){var U="";if(S.type==="group"){U+='<div class="fa fa-users"></div>'}U+=F.escapeHtml(S.component.identity);return U};var N=function(W,T,V,U,S){if(S.type==="group"){return"Members: <b>"+S.component.users.map(function(X){return F.escapeHtml(X.component.identity)}).join("</b>, <b>")+"</b>"}else{return"Member of: <b>"+S.component.userGroups.map(function(X){return F.escapeHtml(X.component.identity)}).join("</b>, <b>")+"</b>"}};var Q=function(X,T,W,V,S){var U="";if(L&&S.component.configurable===true&&F.canModifyTenants()){U+='<div title="Edit" class="pointer edit-user fa fa-pencil"></div>';U+='<div title="Remove" class="pointer delete-user fa fa-trash"></div>'}if(!F.isEmpty(S.component.accessPolicies)){U+='<div title="View User Policies" class="pointer view-user-policies fa fa-key" style="margin-left: 3px;"></div>'}return U};var O=[{id:"identity",name:"User",sortable:true,resizable:true,formatter:K},{id:"membersGroups",name:"&nbsp;",sortable:true,defaultSortAsc:false,resizable:true,formatter:N},{id:"actions",name:"&nbsp;",sortable:false,resizable:false,formatter:Q,width:100,maxWidth:100}];var M={forceFitColumns:true,enableTextSelectionOnCells:true,enableCellNavigation:true,enableColumnReorder:false,autoEdit:false};var R=new b.Data.DataView({inlineFilters:false});R.setItems([]);R.setFilterArgs({searchString:x(),property:w("#users-filter-type").combo("getSelectedOption").value});R.setFilter(y);k({columnId:"identity",sortAsc:true},R);var P=new b.Grid("#users-table",R,O,M);P.setSelectionModel(new b.RowSelectionModel());P.registerPlugin(new b.AutoTooltips());P.setSortColumn("identity",true);P.onSort.subscribe(function(T,S){k({columnId:S.sortCol.id,sortAsc:S.sortAsc},R)});P.onClick.subscribe(function(V,S){var U=w(V.target);var T=R.getItem(S.row);if(P.getColumns()[S.cell].id==="actions"){if(U.hasClass("edit-user")){a(T)}else{if(U.hasClass("view-user-policies")){f(T)}else{if(U.hasClass("delete-user")){j(T)}}}}});R.onRowCountChanged.subscribe(function(T,S){P.updateRowCount();P.render();w("#displayed-users").text(S.current)});R.onRowsChanged.subscribe(function(T,S){P.invalidateRows(S.rows);P.render()});w("#users-table").data("gridInstance",P);w("#displayed-users").text("0")};var k=function(K,M){var L=function(P,N){if(P.permissions.canRead&&N.permissions.canRead){var O=F.isDefinedAndNotNull(P.component[K.columnId])?P.component[K.columnId]:"";var Q=F.isDefinedAndNotNull(N.component[K.columnId])?N.component[K.columnId]:"";return O===Q?0:O>Q?1:-1}else{if(!P.permissions.canRead&&!N.permissions.canRead){return 0}if(P.permissions.canRead){return 1}else{return -1}}};M.sort(L,K.sortAsc)};var G=function(K){if(K.component.resource.startsWith("/restricted-components")){return E(K)}else{if(F.isDefinedAndNotNull(K.component.componentReference)){return J(K)}else{var L=F.getPolicyTypeListing(F.substringAfterFirst(K.component.resource,"/"));if(F.isDefinedAndNotNull(L)){return I(L)}else{return n(K)}}}};var v=function(K,M){var L=function(P,N){if(P.permissions.canRead&&N.permissions.canRead){if(K.columnId==="action"){var O=F.isDefinedAndNotNull(P.component[K.columnId])?P.component[K.columnId]:"";var Q=F.isDefinedAndNotNull(N.component[K.columnId])?N.component[K.columnId]:"";return O===Q?0:O>Q?1:-1}else{if(K.columnId==="policy"){var O="";var Q="";if(P.permissions.canRead===true){O=G(P)}else{O=P.id}if(N.permissions.canRead===true){Q=G(N)}else{Q=N.id}return O===Q?0:O>Q?1:-1}}}else{if(!P.permissions.canRead&&!N.permissions.canRead){return 0}if(P.permissions.canRead){return 1}else{return -1}}};M.sort(L,K.sortAsc)};var x=function(){return w("#users-filter").val()};var p=function(){var K=w("#users-table").data("gridInstance");if(F.isDefinedAndNotNull(K)){var L=K.getData();L.setFilterArgs({searchString:x(),property:w("#users-filter-type").combo("getSelectedOption").value});L.refresh()}};var y=function(L,K){if(K.searchString===""){return true}try{var N=new RegExp(K.searchString,"i")}catch(M){return false}return L.component[K.property].search(N)>=0};var g=function(){var K=w("#users-table").data("gridInstance");var N=K.getData();var M=w("#available-users");var L=0;w.each(N.getItems(),function(S,R){if(R.type==="user"){var U=w('<div class="user-check nf-checkbox checkbox-unchecked"></div>').addClass("group-user-"+R.id);var T=w('<span class="user-id hidden"></span>').text(R.id);var Q=w('<div class="available-identities nf-checkbox-label"></div>').text(R.component.identity);var P=w('<div class="clear"></div>');var O=w("<li></li>").append(U).append(T).append(Q).append(P).appendTo(M);if(L++%2===0){O.addClass("even")}}})};var z=function(){var K=w("#users-table").data("gridInstance");var M=K.getData();var N=w("#available-groups");var L=0;w.each(M.getItems(),function(S,V){if(V.type==="group"){var U=w('<div class="group-check nf-checkbox checkbox-unchecked"></div>').addClass("user-group-"+V.id);var T=w('<span class="group-id hidden"></span>').text(V.id);var Q=w('<div class="fa fa-users nf-checkbox-label"></div>');var R=w('<div class="available-identities nf-checkbox-label"></div>').text(V.component.identity);var P=w('<div class="clear"></div>');var O=w("<li></li>").append(U).append(T).append(Q).append(R).append(P).appendTo(N);if(L++%2===0){O.addClass("even")}}})};var a=function(K){w("#user-id-edit-dialog").text(K.id);w("#user-identity-edit-dialog").val(K.component.identity);if(K.type==="user"){w("#individual-radio-button").prop("checked",true);w("#user-groups").show();w("#group-members").hide();z();w.each(K.component.userGroups,function(L,M){w("div.group-check.user-group-"+M.id).removeClass("checkbox-unchecked").addClass("checkbox-checked")})}else{w("#group-radio-button").prop("checked",true);w("#user-groups").hide();w("#group-members").show();g();w.each(K.component.users,function(L,M){w("div.user-check.group-user-"+M.id).removeClass("checkbox-unchecked").addClass("checkbox-checked")})}w('#user-dialog input[name="userOrGroup"]').attr("disabled",true);w("#user-dialog").modal("show")};var j=function(K){w("#user-id-delete-dialog").val(K.id);w("#user-identity-delete-dialog").text(K.component.identity);w("#user-delete-dialog").modal("show")};var f=function(K){var L=w("#user-policies-table").data("gridInstance");var M=L.getData();M.beginUpdate();if(F.isDefinedAndNotNull(K.component.accessPolicies)){M.setItems(K.component.accessPolicies)}w("#policies-dialog-user-name").text(K.component.identity);M.endUpdate();M.reSort();L.invalidate();L.getSelectionModel().setSelectedRows([]);w("#user-policies-dialog").modal("show");L.resizeCanvas()};var l={init:function(K,L){u=L;h();r();t();B();q(K);if(K){w("#new-user-button").show();if(F.canModifyTenants()){w("#new-user-button").on("click",function(){g();z();w("#user-dialog").modal("show");w("#user-identity-edit-dialog").focus()});w("#new-user-button").prop("disabled",false)}else{w("#new-user-button").prop("disabled",true)}}},resetTableSize:function(){var K=w("#users-table");if(K.is(":visible")){var L=K.data("gridInstance");if(F.isDefinedAndNotNull(L)){L.resizeCanvas()}}},loadUsersTable:function(){var L=w.ajax({type:"GET",url:C.urls.users,dataType:"json"});var K=w.ajax({type:"GET",url:C.urls.userGroups,dataType:"json"});return w.when(L,K).done(function(N,M){var S=N[0];var Q=M[0];w("#users-last-refreshed").text(S.generated);var O=w("#users-table").data("gridInstance");var P=O.getData();P.beginUpdate();var R=[];w.each(S.users,function(U,T){R.push(w.extend({type:"user"},T))});w.each(Q.userGroups,function(T,U){R.push(w.extend({type:"group"},U))});P.setItems(R);P.endUpdate();P.reSort();O.invalidate();O.getSelectionModel().setSelectedRows([]);w("#total-users").text(P.getLength())}).fail(e.handleAjaxError)}};return l}));