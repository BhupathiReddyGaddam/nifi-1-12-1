(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","d3","nf.Common","nf.Dialog","nf.Graph","nf.Shell","nf.ng.Bridge","nf.ClusterSummary","nf.ErrorHandler","nf.Storage","nf.CanvasUtils","nf.Birdseye","nf.ContextMenu","nf.Actions","nf.ProcessGroup","nf.ParameterContexts"],function(j,r,h,i,m,e,l,o,n,k,g,d,p,f,c,q){return(nf.Canvas=b(j,r,h,i,m,e,l,o,n,k,g,d,p,f,c,q))})}else{if(typeof exports==="object"&&typeof module==="object"){module.exports=(nf.Canvas=b(require("jquery"),require("d3"),require("nf.Common"),require("nf.Dialog"),require("nf.Graph"),require("nf.Shell"),require("nf.ng.Bridge"),require("nf.ClusterSummary"),require("nf.ErrorHandler"),require("nf.Storage"),require("nf.CanvasUtils"),require("nf.Birdseye"),require("nf.ContextMenu"),require("nf.Actions"),require("nf.ProcessGroup"),require("nf.ParameterContexts")))}else{nf.Canvas=b(a.$,a.d3,a.nf.Common,a.nf.Dialog,a.nf.Graph,a.nf.Shell,a.nf.ng.Bridge,a.nf.ClusterSummary,a.nf.ErrorHandler,a.nf.Storage,a.nf.CanvasUtils,a.nf.Birdseye,a.nf.ContextMenu,a.nf.Actions,a.nf.ProcessGroup,a.nf.ParameterContexts)}}}(this,function(w,G,E,h,l,D,k,C,d,o,K,e,s,q,t,N){var A=1;var n=[0,0];var b=1.2;var I=8;var p=0.2;var v=0.6;var P="";var g=false;var z=false;var L="root";var H;var O=null;var i=null;var j=null;var a=false;var F=false;var m=false;var c=null;var f=null;var M=false;var y={urls:{api:"../nifi-api",currentUser:"../nifi-api/flow/current-user",controllerBulletins:"../nifi-api/flow/controller/bulletins",kerberos:"../nifi-api/access/kerberos",oidc:"../nifi-api/access/oidc/exchange",revision:"../nifi-api/flow/revision",banners:"../nifi-api/flow/banners"}};var B=function(Q){if(g){r.reload({transition:true}).done(function(){setTimeout(function(){B(Q)},Q*1000)})}};var J=function(S){var R=new Date().getTime();var Q=r.getGroupId();return w.ajax({type:"GET",url:y.urls.api+"/flow/process-groups/"+encodeURIComponent(Q),dataType:"json"}).done(function(T){var V=T.processGroupFlow;r.setGroupId(V.id);r.setParameterContext(V.parameterContext);var W=V.breadcrumb;if(W.permissions.canRead){r.setGroupName(W.breadcrumb.name)}else{r.setGroupName(W.id)}i=T.permissions;k.injector.get("breadcrumbsCtrl").resetBreadcrumbs();k.digest();k.injector.get("breadcrumbsCtrl").generateBreadcrumbs(W);k.injector.get("breadcrumbsCtrl").resetScrollPosition();var U=W;while(U.parentBreadcrumb!=null){U=U.parentBreadcrumb}if(P==""){P=document.title}if(U.permissions.canRead){document.title=U.breadcrumb.name}else{document.title=P}w("#stats-last-refreshed").text(V.lastRefreshed);if(E.isDefinedAndNotNull(V.parentGroupId)){r.setParentGroupId(V.parentGroupId)}else{r.setParentGroupId(null)}l.expireCaches(R);l.set(V.flow,w.extend({selectAll:false,overrideRevisionCheck:C.didConnectedStateChange()},S));l.updateVisibility();e.refresh()}).fail(d.handleAjaxError)};var u=function(Q,S){var T=r.getGroupId();var U=r.getParameterContext();r.setGroupId(Q);var R=J(S);R.fail(function(X,V,W){r.setGroupId(T);r.setParameterContext(U)});return R};var x=function(){return w.ajax({type:"GET",url:y.urls.currentUser,dataType:"json"}).done(function(Q){E.setCurrentUser(Q)})};var r={CANVAS_OFFSET:0,SUPPORTS_SVG:!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect,hideSplash:function(){w("#splash").fadeOut()},stopPolling:function(){g=false},disableRefreshHotKey:function(){z=true},reload:function(Q,R){return w.Deferred(function(U){var T;if(E.isDefinedAndNotNull(R)){T=u(R,Q)}else{T=J(Q)}var W=k.injector.get("flowStatusCtrl").reloadFlowStatus();var V=x();var S=w.ajax({type:"GET",url:y.urls.controllerBulletins,dataType:"json"}).done(function(Y){k.injector.get("flowStatusCtrl").updateBulletins(Y)});var X=C.loadClusterSummary().done(function(Y){var Z=Y.clusterSummary;if(C.didConnectedStateChange()){if(Z.connectedToCluster){h.showConnectedToClusterMessage(function(){o.resetDisconnectionAcknowledgement()})}else{h.showDisconnectedFromClusterMessage(function(){o.acknowledgeDisconnection()})}}k.injector.get("flowStatusCtrl").updateClusterSummary(Z)});w.when(T,W,V,S,X).done(function(Y){var Z=Y[0];k.digest();U.resolve(Z)}).fail(function(aa,Y,Z){U.reject(aa,Y,Z)})}).promise()},initCanvas:function(){var X=w("#canvas-container");c=G.select("#canvas-container").append("svg").on("contextmenu",function(){M=false;K.getSelection().classed("selected",false);K.setURLParameters();s.show();G.event.preventDefault()});var Q=c.append("defs");Q.selectAll("marker").data(["normal","ghost","unauthorized","full"]).enter().append("marker").attrs({id:function(Y){return Y},viewBox:"0 0 6 6",refX:5,refY:3,markerWidth:6,markerHeight:6,orient:"auto",fill:function(Y){if(Y==="ghost"){return"#aaaaaa"}else{if(Y==="unauthorized"){return"#ba554a"}else{if(Y==="full"){return"#ba554a"}else{return"#000000"}}}}}).append("path").attr("d","M2,3 L0,6 L6,3 L0,0 z");var T=Q.append("filter").attrs({id:"component-drop-shadow",height:"140%",y:"-20%"});T.append("feGaussianBlur").attrs({"in":"SourceAlpha",stdDeviation:3,result:"blur"});T.append("feOffset").attrs({"in":"blur",dx:0,dy:1,result:"offsetBlur"});T.append("feFlood").attrs({"flood-color":"#000000","flood-opacity":0.4,result:"offsetColor"});T.append("feComposite").attrs({"in":"offsetColor",in2:"offsetBlur",operator:"in",result:"offsetColorBlur"});var V=T.append("feMerge");V.append("feMergeNode").attr("in","offsetColorBlur");V.append("feMergeNode").attr("in","SourceGraphic");var S=Q.append("filter").attrs({id:"connection-full-drop-shadow",height:"140%",y:"-20%"});S.append("feGaussianBlur").attrs({"in":"SourceAlpha",stdDeviation:3,result:"blur"});S.append("feOffset").attrs({"in":"blur",dx:0,dy:1,result:"offsetBlur"});S.append("feFlood").attrs({"flood-color":"#ba554a","flood-opacity":1,result:"offsetColor"});S.append("feComposite").attrs({"in":"offsetColor",in2:"offsetBlur",operator:"in",result:"offsetColorBlur"});var W=S.append("feMerge");W.append("feMergeNode").attr("in","offsetColorBlur");W.append("feMergeNode").attr("in","SourceGraphic");f=c.append("g").attrs({transform:"translate("+n+") scale("+A+")","pointer-events":"all",id:"canvas"});c.on("mousedown.selection",function(){M=true;if(G.event.button!==0){G.event.stopImmediatePropagation();return}if(G.event.shiftKey){var Y=G.mouse(f.node());f.append("rect").attr("rx",6).attr("ry",6).attr("x",Y[0]).attr("y",Y[1]).attr("class","component-selection").attr("width",0).attr("height",0).attr("stroke-width",function(){return 1/r.View.getScale()}).attr("stroke-dasharray",function(){return 4/r.View.getScale()}).datum(Y);G.event.stopImmediatePropagation();G.event.preventDefault()}}).on("mousemove.selection",function(){if(G.event.shiftKey){var Z=G.select("rect.component-selection");if(!Z.empty()){var aa=Z.datum();var Y=G.mouse(f.node());var ab={};if(aa[0]<Y[0]){ab.x=aa[0];ab.width=Y[0]-aa[0]}else{ab.x=Y[0];ab.width=aa[0]-Y[0]}if(aa[1]<Y[1]){ab.y=aa[1];ab.height=Y[1]-aa[1]}else{ab.y=Y[1];ab.height=aa[1]-Y[1]}Z.attrs(ab);G.event.stopPropagation()}}}).on("mouseup.selection",function(){if(M===false){return}M=false;var Y=G.select("rect.component-selection");if(!Y.empty()){var Z={x:parseInt(Y.attr("x"),10),y:parseInt(Y.attr("y"),10),width:parseInt(Y.attr("width"),10),height:parseInt(Y.attr("height"),10)};G.selectAll("g.component").classed("selected",function(aa){return G.select(this).classed("selected")||aa.position.x>=Z.x&&(aa.position.x+aa.dimensions.width)<=(Z.x+Z.width)&&aa.position.y>=Z.y&&(aa.position.y+aa.dimensions.height)<=(Z.y+Z.height)});G.selectAll("g.connection").classed("selected",function(ac){var ab=[ac.start].concat(ac.bends,[ac.end]);var aa=G.extent(ab,function(ae){return ae.x});var ad=G.extent(ab,function(ae){return ae.y});return G.select(this).classed("selected")||aa[0]>=Z.x&&aa[1]<=(Z.x+Z.width)&&ad[0]>=Z.y&&ad[1]<=(Z.y+Z.height)});Y.remove();K.setURLParameters()}k.digest()});var U=function(){var ac=w("#banner-footer");var Y=0;if(ac.is(":visible")){Y=ac.height()}var aa=parseInt(X.css("top"),10);var ab=w(window).height();var Z=(ab-(Y+aa));X.css({height:Z+"px",bottom:Y+"px"});c.attrs({height:X.height(),width:w(window).width()});k.injector.get("breadcrumbsCtrl").updateBreadcrumbsCss({bottom:Y+"px"});w("#canvas-body").css({height:ab+"px",width:w(window).width()+"px"})};w("body").on("GoTo:Component",function(Z,Y){K.showComponent(Y.parentGroupId,Y.id)});w("body").on("GoTo:ProcessGroup",function(Z,Y){t.enterGroup(Y.id).done(function(){K.getSelection().classed("selected",false);k.digest()})});w("body").on("GoTo:ParameterContext",function(Z,Y){N.showParameterContexts(Y.id)});var R=E.throttle(q.reload,1000);w(window).on("resize",function(ag){if(ag.target===window){if(w(".md-menu-backdrop").is(":visible")===true){w(".md-menu-backdrop").click()}U();var ae=w("#shell-dialog");if(ae.is(":visible")){setTimeout(function(ai){D.resizeContent(ai);if(ai.find("#shell-iframe").is(":visible")){D.resizeIframe(ai)}},50,ae)}var Y=w(".dialog");for(var ad=0,af=Y.length;ad<af;ad++){if(w(Y[ad]).is(":visible")){setTimeout(function(ai){ai.modal("resize")},50,w(Y[ad]))}}var ah=w('*[class*="slickgrid_"]');for(var ac=0,af=ah.length;ac<af;ac++){if(w(ah[ac]).is(":visible")){setTimeout(function(aj){var ai=aj.data("gridInstance");var ak=ai.getEditorLock();if(!ak.isActive()){ai.resizeCanvas()}},50,w(ah[ac]))}}var aa=w(".tab-container");var Z=[];for(var ab=0,af=aa.length;ab<af;ab++){if(w(aa[ab]).is(":visible")){Z.push(w("#"+w(aa[ab]).attr("id")+"-content"))}}w.each(Z,function(ai,aj){E.toggleScrollable(aj.get(0))})}}).on("keydown",function(Y){if(w(".dialog").is(":visible")||w("#search-field").is(":focus")){return}var Z=K.getSelection();var aa=Y.ctrlKey||Y.metaKey;if(aa){if(Y.keyCode===82){if(z===true){location.reload();return}R()}else{if(Y.keyCode===65){q.selectAll();K.setURLParameters();k.digest();Y.preventDefault()}else{if(Y.keyCode===67){if(r.canWrite()&&K.isCopyable(Z)){q.copy(Z)}}else{if(Y.keyCode===86){if(r.canWrite()&&K.isPastable()){q.paste(Z);Y.preventDefault()}}}}}}else{if(Y.keyCode===8||Y.keyCode===46){if(r.canWrite()&&K.areDeletable(Z)){q["delete"](Z)}}}});w.ajax({type:"GET",url:y.urls.banners,dataType:"json"}).done(function(aa){if(E.isDefinedAndNotNull(aa.banners)){if(E.isDefinedAndNotNull(aa.banners.headerText)&&aa.banners.headerText!==""){w("#banner-header").addClass("banner-header-background").text(aa.banners.headerText).show();w("#canvas-container").css("top","98px")}if(E.isDefinedAndNotNull(aa.banners.footerText)&&aa.banners.footerText!==""){var Y=w("#banner-footer").text(aa.banners.footerText).show();var Z=function(ab){var ac=w("#"+ab);ac.css("bottom",parseInt(Y.css("height"),10)+"px")};Z("graph")}}U()}).fail(d.handleAjaxError)},init:function(){var Q=w.Deferred(function(R){var S=function(V){var U=E.getJwtPayload(V);var T=parseInt(U.exp,10)*E.MILLIS_PER_SECOND;o.setItem("jwt",V,T);R.resolve()};if(o.hasItem("jwt")){R.resolve()}else{w.ajax({type:"POST",url:y.urls.kerberos,dataType:"text"}).done(function(T){S(T)}).fail(function(){w.ajax({type:"POST",url:y.urls.oidc,dataType:"text"}).done(function(T){S(T)}).fail(function(){R.reject()})})}}).promise();return w.Deferred(function(R){Q.always(function(){x().done(function(S){if(S.anonymous===false){w("#current-user").text(S.identity).show();if(o.getItem("jwt")!==null){w("#logout-link-container").show()}}else{E.setAnonymousUserLabel()}R.resolve()}).fail(function(U,S,T){if(U.status===401){window.location="../nifi/login"}else{R.reject(U,S,T)}})})}).promise()},setParameterContext:function(Q){H=Q},getParameterContext:function(){return H},setGroupId:function(Q){L=Q},getGroupId:function(){return L},setGroupName:function(Q){O=Q},getGroupName:function(){return O},setParentGroupId:function(Q){j=Q},getParentGroupId:function(){return j},setManagedAuthorizer:function(Q){a=Q},isManagedAuthorizer:function(){return a},setConfigurableAuthorizer:function(Q){F=Q},isConfigurableAuthorizer:function(){return F},setConfigurableUsersAndGroups:function(Q){m=Q},isConfigurableUsersAndGroups:function(){return m},canRead:function(){if(i===null){return false}else{return i.canRead===true}},canWrite:function(){if(i===null){return false}else{return i.canWrite===true}},startPolling:function(Q){g=true;B(Q)},View:(function(){var S;var Q=0,T=0,R=A;return{init:function(){var W;var V=false;var X=function(Y){if(E.isDefinedAndNotNull(Y)){if(E.isDefinedAndNotNull(Y.subject)){return Y.subject.source==="birdseye"}else{return false}}else{return false}};var U=function(Y){if(E.isDefinedAndNotNull(Y)){if(X(Y)){return false}return Y.type==="wheel"||Y.type==="mousewheel"}else{return true}};S=G.zoom().scaleExtent([p,I]).on("start",function(){s.hide()}).on("zoom",function(){if(!isNaN(G.event.transform.x)){Q=G.event.transform.x}if(!isNaN(G.event.transform.y)){T=G.event.transform.y}if(!isNaN(G.event.transform.k)){R=G.event.transform.k}V=true;W=r.View.refresh({persist:false,transition:U(G.event.sourceEvent),refreshComponents:false,refreshBirdseye:false})}).on("end",function(){if(!X(G.event.sourceEvent)){if(E.isDefinedAndNotNull(W)){l.updateVisibility();W.done(function(){e.refresh()});K.persistUserView();W=null}if(V===false){K.getSelection().classed("selected",false);K.setURLParameters();k.digest()}}V=false});c.call(S).on("dblclick.zoom",null)},shouldRenderPerScale:function(){return r.View.getScale()>=v},translate:function(U){S.translateBy(c,U[0],U[1])},scale:function(U){S.scaleBy(c,U)},transform:function(V,U){S.transform(c,G.zoomIdentity.translate(V[0],V[1]).scale(U))},getTranslate:function(){return[Q,T]},getScale:function(){return R},zoomIn:function(){r.View.scale(b)},zoomOut:function(){r.View.scale(1/b)},fit:function(){var W=r.View.getTranslate();var Y=r.View.getScale();var ab;var aa=w("#canvas-container");var X=aa.width();var Z=aa.height();var ad=G.select("#canvas").node().getBoundingClientRect();var ae=ad.width/Y;var V=ad.height/Y;var ac=ad.left/Y;var U=(ad.top-r.CANVAS_OFFSET)/Y;if(ae>X||V>Z){ab=Math.min(X/ae,Z/V);ab=Math.min(Math.max(ab,p),I)}else{ab=1;ac-=100;U-=50}K.centerBoundingBox({x:ac-(W[0]/Y),y:U-(W[1]/Y),width:X/ab,height:Z/ab,scale:ab})},actualSize:function(){var Z=r.View.getTranslate();var Y=r.View.getScale();var V=K.getSelection();var W;if(!V.empty()){var U=V.node().getBoundingClientRect();W={x:(U.left/Y)-(Z[0]/Y),y:((U.top-r.CANVAS_OFFSET)/Y)-(Z[1]/Y),width:U.width/Y,height:U.height/Y,scale:1}}else{var ab=w("#canvas-container");var X=ab.width()/Y;var aa=ab.height()/Y;W={x:(X/2)-(Z[0]/Y),y:(aa/2)-(Z[1]/Y),width:1,height:1,scale:1}}K.centerBoundingBox(W)},refresh:function(U){return w.Deferred(function(V){var Y=true;var aa=false;var Z=true;var ab=true;if(E.isDefinedAndNotNull(U)){Y=E.isDefinedAndNotNull(U.persist)?U.persist:Y;aa=E.isDefinedAndNotNull(U.transition)?U.transition:aa;Z=E.isDefinedAndNotNull(U.refreshComponents)?U.refreshComponents:Z;ab=E.isDefinedAndNotNull(U.refreshBirdseye)?U.refreshBirdseye:ab}if(Z){l.updateVisibility()}if(Y===true){K.persistUserView()}var W=r.View.getTranslate();var X=r.View.getScale();if(aa===true){f.transition().duration(500).attr("transform",function(){return"translate("+W+") scale("+X+")"}).on("end",function(){if(ab===true){e.refresh()}V.resolve()})}else{f.attr("transform",function(){return"translate("+W+") scale("+X+")"});if(ab===true){e.refresh()}V.resolve()}}).promise()}}}())};return r}));