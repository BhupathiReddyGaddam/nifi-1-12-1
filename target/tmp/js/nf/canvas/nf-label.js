(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","d3","nf.Storage","nf.Common","nf.Client","nf.CanvasUtils"],function(g,f,d,h,c,e){return(nf.Label=b(g,f,d,h,c,e))})}else{if(typeof exports==="object"&&typeof module==="object"){module.exports=(nf.Label=b(require("jquery"),require("d3"),require("nf.Storage"),require("nf.Common"),require("nf.Client"),require("nf.CanvasUtils")))}else{nf.Label=b(a.$,a.d3,a.nf.Storage,a.nf.Common,a.nf.Client,a.nf.CanvasUtils)}}}(this,function(e,x,g,k,z,u){var n;var r;var m;var l;var s;var j={width:148,height:148};var a=24;var i=64;var f;var w;var d;var b;var c;var v=8;var p=true;var q=function(){return b.selectAll("g.label").data(f.values(),function(A){return A.id})};var y=function(C,B){if(C.empty()){return C}var A=C.append("g").attrs({id:function(D){return"id-"+D.id},"class":"label component"}).classed("selected",B).call(u.position);A.append("rect").attrs({"class":"border",fill:"transparent",stroke:"transparent"});A.append("rect").attrs({"class":"body",filter:"url(#component-drop-shadow)","stroke-width":0});A.append("text").attrs({"xml:space":"preserve","font-weight":"bold",fill:"black","class":"label-value"});A.call(m.activate).call(s.activate).call(l.activate);return A};var h=function(A){if(A.empty()){return}A.select("rect.border").attrs({width:function(B){return B.dimensions.width},height:function(B){return B.dimensions.height}}).classed("unauthorized",function(B){return B.permissions.canRead===false});A.select("rect.body").attrs({width:function(B){return B.dimensions.width},height:function(B){return B.dimensions.height}}).style("fill",function(C){if(!C.permissions.canRead){return null}var B=o.defaultColor();if(k.isDefinedAndNotNull(C.component.style["background-color"])){B=C.component.style["background-color"]}return B}).classed("unauthorized",function(B){return B.permissions.canRead===false});A.each(function(F){var G=x.select(this);u.editable(G,n,r);var C=G.select("text.label-value");var D=G.selectAll("rect.labelpoint");if(F.permissions.canRead){C.attr("font-size",function(){var K="12px";if(k.isDefinedAndNotNull(F.component.style["font-size"])){K=F.component.style["font-size"]}return K});C.selectAll("tspan").remove();var J=[];if(k.isDefinedAndNotNull(F.component.label)){J=F.component.label.split("\n")}else{J.push("")}var E=o.defaultColor();if(k.isDefinedAndNotNull(F.component.style["background-color"])){E=F.component.style["background-color"]}e.each(J,function(L,K){C.append("tspan").attr("x","0.4em").attr("dy","1.2em").text(function(){return K}).style("fill",function(M){return k.determineContrastColor(k.substringAfterLast(E,"#"))})});if(F.permissions.canWrite){var I=[{x:F.dimensions.width,y:F.dimensions.height}];var H=D.data(I);var B=H.enter().append("rect").attrs({"class":"labelpoint",width:10,height:10}).call(c);H.merge(B).attr("transform",function(K){return"translate("+(K.x-10)+", "+(K.y-10)+")"});H.exit().remove()}}else{C.selectAll("tspan").remove();D.remove()}})};var t=function(A){A.remove()};var o={config:{width:j.width,height:j.height},init:function(C,D,A,B,E){n=C;r=D;m=A;s=B;l=E;f=x.map();w=x.map();d=x.map();b=x.select("#canvas").append("g").attrs({"pointer-events":"all","class":"labels"});c=x.drag().on("start",function(){x.event.sourceEvent.stopPropagation()}).on("drag",function(){var F=x.select(this.parentNode);var G=F.datum();p=!x.event.sourceEvent.shiftKey;G.dimensions.width=Math.max(i,p?(Math.round(x.event.x/v)*v):x.event.x);G.dimensions.height=Math.max(a,p?(Math.round(x.event.y/v)*v):x.event.y);h(F)}).on("end",function(){var G=x.select(this.parentNode);var H=G.datum();var I=false;if(k.isDefinedAndNotNull(H.component.width)||H.dimensions.width!==H.component.width){I=true}if(!I&&k.isDefinedAndNotNull(H.component.height)||H.dimensions.height!==H.component.height){I=true}if(I){var F={revision:z.getRevision(H),disconnectedNodeAcknowledged:g.isDisconnectionAcknowledged(),component:{id:H.id,width:H.dimensions.width,height:H.dimensions.height}};e.ajax({type:"PUT",url:H.uri,data:JSON.stringify(F),dataType:"json",contentType:"application/json"}).done(function(J){o.set(J)}).fail(function(){var K=j.width;if(k.isDefinedAndNotNull(H.component.width)){K=H.component.width}var J=j.height;if(k.isDefinedAndNotNull(H.component.height)){J=H.component.height}H.dimensions={width:K,height:J};G.call(h)})}x.event.sourceEvent.stopPropagation()})},add:function(D,B){var F=false;if(k.isDefinedAndNotNull(B)){F=k.isDefinedAndNotNull(B.selectAll)?B.selectAll:F}var A=new Date().getTime();var G=function(H){d.set(H.id,A);f.set(H.id,e.extend({type:"Label"},H))};if(e.isArray(D)){e.each(D,function(I,H){G(H)})}else{if(k.isDefinedAndNotNull(D)){G(D)}}var C=q();var E=y(C.enter(),F);h(C.merge(E))},set:function(B,I){var A=false;var F=false;var C=false;if(k.isDefinedAndNotNull(I)){A=k.isDefinedAndNotNull(I.selectAll)?I.selectAll:A;F=k.isDefinedAndNotNull(I.transition)?I.transition:F;C=k.isDefinedAndNotNull(I.overrideRevisionCheck)?I.overrideRevisionCheck:C}var G=function(J){var K=f.get(J.id);if((z.isNewerRevision(K,J)&&!w.has(J.id))||C===true){f.set(J.id,e.extend({type:"Label"},J))}};if(e.isArray(B)){e.each(f.keys(),function(K,M){var L=f.get(M);var J=e.grep(B,function(N){return N.id===L.id});if(J.length===0&&!d.has(M)){f.remove(M)}});e.each(B,function(K,J){G(J)})}else{if(k.isDefinedAndNotNull(B)){G(B)}}var H=q();var E=y(H.enter(),A);var D=H.merge(E);D.call(h).call(u.position,F);H.exit().call(t)},get:function(A){if(k.isUndefined(A)){return f.values()}else{return f.get(A)}},refresh:function(A){if(k.isDefinedAndNotNull(A)){x.select("#id-"+A).call(h)}else{x.selectAll("g.label").call(h)}},reload:function(B){if(f.has(B)){var A=f.get(B);return e.ajax({type:"GET",url:A.uri,dataType:"json"}).done(function(C){o.set(C)})}},position:function(A){x.select("#id-"+A).call(u.position)},remove:function(B){var A=new Date().getTime();if(e.isArray(B)){e.each(B,function(C,D){w.set(D,A);f.remove(D)})}else{w.set(B,A);f.remove(B)}q().exit().call(t)},removeAll:function(){o.remove(f.keys())},expireCaches:function(B){var A=function(C){C.each(function(D,E){if(B>D){C.remove(E)}})};A(d);A(w)},defaultColor:function(){return"#fff7d7"}};return o}));