(function(a,b){if(typeof define==="function"&&define.amd){define(["d3","nf.Connection","nf.ConnectionConfiguration","nf.CanvasUtils"],function(d,f,e,c){return(nf.Connectable=b(d,f,e,c))})}else{if(typeof exports==="object"&&typeof module==="object"){module.exports=(nf.Connectable=b(require("d3"),require("nf.Connection"),require("nf.ConnectionConfiguration"),require("nf.CanvasUtils")))}else{nf.Connectable=b(a.d3,a.nf.Connection,a.nf.ConnectionConfiguration,a.nf.CanvasUtils)}}}(this,function(f,h,g,e){var c;var d;var b;var a=function(){return !f.event.shiftKey&&f.select("rect.drag-selection").empty()&&f.select("rect.component-selection").empty()};return{init:function(){d=f.select("#canvas");c=f.drag().subject(function(i){b=f.mouse(d.node());return{x:b[0],y:b[1]}}).on("start",function(l){f.event.sourceEvent.stopPropagation();e.getSelection().classed("selected",false);var k=f.select(this.parentNode).classed("selected",true);f.select(this).classed("dragging",true);var j=k.datum();var i=f.mouse(d.node());d.insert("path",":first-child").datum({sourceId:j.id,sourceWidth:j.dimensions.width,x:i[0],y:i[1]}).attrs({"class":"connector",d:function(m){return"M"+m.x+" "+m.y+"L"+m.x+" "+m.y}});f.select(this).attr("transform",function(){return"translate("+i[0]+", "+(i[1]+20)+")"});d.node().appendChild(this)}).on("drag",function(j){f.select(this).attr("transform",function(){return"translate("+f.event.x+", "+(f.event.y+50)+")"});var i=f.select("g.hover").classed("connectable-destination",function(){return(Math.abs(b[0]-f.event.x)>10||Math.abs(b[1]-f.event.y)>10)&&e.isValidConnectionDestination(f.select(this))});f.select("path.connector").classed("connectable",function(){if(i.empty()){return false}return i.classed("connectable-destination")}).attr("d",function(r){if(!i.empty()&&i.classed("connectable-destination")){var m=i.datum();if(r.sourceId===m.id){var k=r.x;var q=r.y;var o=r.sourceWidth/2;var n=h.config.selfLoopXOffset;var p=h.config.selfLoopYOffset;return"M"+k+" "+q+"L"+(k+o+n)+" "+(q-p)+"L"+(k+o+n)+" "+(q+p)+"Z"}else{var l=e.getPerimeterPoint(r,{x:m.position.x,y:m.position.y,width:m.dimensions.width,height:m.dimensions.height});return"M"+r.x+" "+r.y+"L"+l.x+" "+l.y}}else{return"M"+r.x+" "+r.y+"L"+f.event.x+" "+f.event.y}})}).on("end",function(o){f.event.sourceEvent.stopPropagation();var q=f.select(this);var l=f.select("path.connector");var j=l.datum();var p=f.select("g.connectable-destination");if(p.empty()){var i=f.select("#id-"+j.sourceId);var m=i.datum();var n=f.mouse(i.node());if(n[0]<0||n[0]>m.dimensions.width||n[1]<0||n[1]>m.dimensions.height){q.remove()}else{q.classed("dragging",false).attr("transform",function(){return"translate("+o.origX+", "+o.origY+")"});i.node().appendChild(this)}l.remove()}else{q.remove();var k=p.datum();g.createConnection(j.sourceId,k.id)}})},activate:function(i){i.classed("connectable",true).on("mouseenter.connectable",function(m){if(a()){var k=f.select(this);if(e.isValidConnectionSource(k)){var l=f.select("text.add-connect");if(l.empty()){var j=(m.dimensions.width/2)-14;var n=(m.dimensions.height/2)+14;k.append("text").datum({origX:j,origY:n}).call(c).attrs({"class":"add-connect",transform:"translate("+j+", "+n+")"}).text("\ue834")}}}}).on("mouseleave.connectable",function(){var j=f.select(this).select("text.add-connect");if(!j.empty()&&!j.classed("dragging")){j.remove()}}).on("mouseover.connectable",function(){f.select(this).classed("hover",function(){return a()})}).on("mouseout.connection",function(){f.select(this).classed("hover connectable-destination",false)})},deactivate:function(i){i.classed("connectable",false).on("mouseenter.connectable",null).on("mouseleave.connectable",null).on("mouseover.connectable",null).on("mouseout.connectable",null)}}}));