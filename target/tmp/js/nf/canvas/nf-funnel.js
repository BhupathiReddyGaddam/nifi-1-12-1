(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","d3","nf.Common","nf.Client","nf.CanvasUtils"],function(f,e,g,c,d){return(nf.Funnel=b(f,e,g,c,d))})}else{if(typeof exports==="object"&&typeof module==="object"){module.exports=(nf.Funnel=b(require("jquery"),require("d3"),require("nf.Common"),require("nf.Client"),require("nf.CanvasUtils")))}else{nf.Funnel=b(a.$,a.d3,a.nf.Common,a.nf.Client,a.nf.CanvasUtils)}}}(this,function(b,r,d,s,o){var i;var l;var e;var m;var c={width:48,height:48};var j;var q;var a;var p;var k=function(){return p.selectAll("g.funnel").data(j.values(),function(t){return t.id})};var g=function(v,u){if(v.empty()){return v}var t=v.append("g").attrs({id:function(w){return"id-"+w.id},"class":"funnel component"}).classed("selected",u).call(o.position);t.append("rect").attrs({rx:2,ry:2,"class":"border",width:function(w){return w.dimensions.width},height:function(w){return w.dimensions.height},fill:"transparent",stroke:"transparent"});t.append("rect").attrs({rx:2,ry:2,"class":"body",width:function(w){return w.dimensions.width},height:function(w){return w.dimensions.height},filter:"url(#component-drop-shadow)","stroke-width":0});t.append("text").attrs({"class":"funnel-icon",x:9,y:34}).text("\ue803");t.call(e.activate).call(m.activate);return t};var h=function(t){if(t.empty()){return}t.select("rect.border").classed("unauthorized",function(u){return u.permissions.canRead===false});t.select("rect.body").classed("unauthorized",function(u){return u.permissions.canRead===false});t.each(function(){var u=r.select(this);o.editable(u,i,l)})};var f=function(t){t.remove()};var n={init:function(v,w,t,u){i=v;l=w;e=t;m=u;j=r.map();q=r.map();a=r.map();p=r.select("#canvas").append("g").attrs({"pointer-events":"all","class":"funnels"})},add:function(v,u){var y=false;if(d.isDefinedAndNotNull(u)){y=d.isDefinedAndNotNull(u.selectAll)?u.selectAll:y}var t=new Date().getTime();var z=function(A){a.set(A.id,t);j.set(A.id,b.extend({type:"Funnel",dimensions:c},A))};if(b.isArray(v)){b.each(v,function(B,A){z(A)})}else{if(d.isDefinedAndNotNull(v)){z(v)}}var w=k();var x=g(w.enter(),y);h(w.merge(x))},set:function(u,B){var t=false;var y=false;var v=false;if(d.isDefinedAndNotNull(B)){t=d.isDefinedAndNotNull(B.selectAll)?B.selectAll:t;y=d.isDefinedAndNotNull(B.transition)?B.transition:y;v=d.isDefinedAndNotNull(B.overrideRevisionCheck)?B.overrideRevisionCheck:v}var z=function(D){var C=j.get(D.id);if((s.isNewerRevision(C,D)&&!q.has(D.id))||v===true){j.set(D.id,b.extend({type:"Funnel",dimensions:c},D))}};if(b.isArray(u)){b.each(j.keys(),function(D,F){var E=j.get(F);var C=b.grep(u,function(G){return G.id===E.id});if(C.length===0&&!a.has(F)){j.remove(F)}});b.each(u,function(D,C){z(C)})}else{if(d.isDefinedAndNotNull(u)){z(u)}}var A=k();var x=g(A.enter(),t);var w=A.merge(x);w.call(h).call(o.position,y);A.exit().call(f)},get:function(t){if(d.isUndefined(t)){return j.values()}else{return j.get(t)}},refresh:function(t){if(d.isDefinedAndNotNull(t)){r.select("#id-"+t).call(h)}else{r.selectAll("g.funnel").call(h)}},reload:function(u){if(j.has(u)){var t=j.get(u);return b.ajax({type:"GET",url:t.uri,dataType:"json"}).done(function(v){n.set(v)})}},position:function(t){r.select("#id-"+t).call(o.position)},remove:function(u){var t=new Date().getTime();if(b.isArray(u)){b.each(u,function(w,v){q.set(v,t);j.remove(v)})}else{q.set(u,t);j.remove(u)}k().exit().call(f)},removeAll:function(){n.remove(j.keys())},expireCaches:function(u){var t=function(v){v.each(function(w,x){if(u>w){v.remove(x)}})};t(a);t(q)}};return n}));