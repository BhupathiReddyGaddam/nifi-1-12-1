(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","d3","nf.Common","nf.Dialog","nf.ErrorHandler"],function(e,c,f,d,g){return(nf.StatusHistory=b(e,c,f,d,g))})}else{if(typeof exports==="object"&&typeof module==="object"){module.exports=(nf.StatusHistory=b(require("jquery"),require("d3"),require("nf.Common"),require("nf.Dialog"),require("nf.ErrorHandler")))}else{nf.StatusHistory=b(a.$,a.d3,a.nf.Common,a.nf.Dialog,a.nf.ErrorHandler)}}}(this,function(e,x,h,s,g){var w={nifiInstanceId:"nifi-instance-id",nifiInstanceLabel:"NiFi",type:{processor:"Processor",inputPort:"Input Port",outputPort:"Output Port",processGroup:"Process Group",remoteProcessGroup:"Remote Process Group",connection:"Connection",funnel:"Funnel",template:"Template",label:"Label"},urls:{api:"../nifi-api"}};var v={DURATION:function(z){return h.formatDuration(z)},COUNT:function(z){if(z%1===0){return h.formatInteger(z)}else{return h.formatFloat(z)}},DATA_SIZE:function(z){return h.formatDataSize(z)}};var n=null;var c=null;var q=null;var d=null;var k=function(B,F,D,A,E){e("#status-history-last-refreshed").text(D.generated);var z={groupId:B,id:F,type:A,instances:[]};var C=D.fieldDescriptors;z.details=D.componentDetails;z.selectedDescriptor=h.isUndefined(E)?C[0]:E;if(h.isDefinedAndNotNull(D.aggregateSnapshots)&&D.aggregateSnapshots.length>1){z.instances.push({id:w.nifiInstanceId,label:w.nifiInstanceLabel,snapshots:D.aggregateSnapshots})}else{j();return}e.each(D.nodeSnapshots,function(H,G){if(h.isDefinedAndNotNull(G.statusSnapshots)&&G.statusSnapshots.length>1){z.instances.push({id:G.nodeId,label:G.address+":"+G.apiPort,snapshots:G.statusSnapshots})}});if(z.instances.length>0){e("#status-history-dialog").data("status-history",z);r(z,C)}else{j()}};var j=function(){s.showOkDialog({headerText:"Status History",dialogContent:"Insufficient history, please try again later."})};var r=function(z,A){if(d===null){d={}}e.each(z.instances,function(C,B){B.snapshots.forEach(function(F){var E=new Date();var D=E.getTimezoneOffset()*60*1000;F.timestamp=new Date(F.timestamp+D+n)})});m(A,z.selectedDescriptor)};var m=function(B,A){var z=[];e.each(B,function(C,D){z.push({text:D.label,value:D.field,description:h.escapeHtml(D.description)})});e("#status-history-metric-combo").combo({selectedOption:{value:A.field},options:z,select:function(D){var E=null;e.each(B,function(F,G){if(D.value===G.field){E=G;return false}});if(E!==null){if(q===null||q.field!==E.field){c=null}q=E;var C=e("#status-history-dialog").data("status-history");C.selectedDescriptor=E;e("#status-history-dialog").data("status-history",C);l()}}});e("#status-history-dialog").modal("show")};var a=function(){return e("#status-history-chart-container").parent().outerHeight()-e("#status-history-chart-control-container").outerHeight()-parseInt(e("#status-history-chart-control-container").css("margin-top"),10)};var y=function(){return e("body").height()-e("#status-history-chart-control-container").outerHeight()-e("#status-history-refresh-container").outerHeight()-parseInt(e("#status-history-chart-control-container").css("margin-top"),10)-parseInt(e(".dialog-content").css("top"))-parseInt(e(".dialog-content").css("bottom"))};var u=function(){return e("body").width()-e("#status-history-details").innerWidth()-parseInt(e("#status-history-dialog").css("left"),10)-parseInt(e(".dialog-content").css("left"))-parseInt(e(".dialog-content").css("right"))};var l=function(){var ah=e("#status-history-dialog");if(ah.is(":visible")){var aa=ah.data("status-history");var ag=aa.selectedDescriptor;e("#status-history-details").empty();var C=o("Status History");x.map(aa.details).each(function(aw,av){i(C,av,aw)});var E={top:15,right:20,bottom:25,left:75};var X=x.scaleOrdinal(x.schemeCategory10);var B=[];e.each(aa.instances,function(aw,av){B.push(av.label)});X.domain(B);var ar=[];e.each(aa.instances,function(aw,av){if(h.isUndefinedOrNull(d[av.id])){d[av.id]=true}ar.push({id:av.id,label:av.label,values:e.map(av.snapshots,function(ax){return{timestamp:ax.timestamp,value:ax.statusMetrics[ag.field]}}),visible:d[av.id]===true})});var O=function(av){if(av.getMilliseconds()){return x.timeFormat(":%S.%L")(av)}else{if(av.getSeconds()){return x.timeFormat(":%S")(av)}else{if(av.getMinutes()||av.getHours()){return x.timeFormat("%H:%M")(av)}else{if(av.getDay()&&av.getDate()!==1){return x.timeFormat("%a %d")(av)}else{if(av.getDate()!==1){return x.timeFormat("%b %d")(av)}else{if(av.getMonth()){return x.timeFormat("%B")(av)}else{return x.timeFormat("%Y")(av)}}}}}}};var N=e("#status-history-chart-container").empty();if(N.hasClass("ui-resizable")){N.resizable("destroy");N.removeAttr("style")}N.height(a());var z=N.outerWidth()-E.left-E.right;var A=N.outerHeight()-E.top-E.bottom;V=e("#status-history-container").width();if(z>V){z=V}am=y();if(A>am){A=am}var ae=x.scaleTime().range([0,z]);var U=x.axisBottom(ae).ticks(5).tickFormat(O);var ad=x.scaleLinear().range([A,0]);var F=x.axisLeft(ad).tickFormat(v[ag.formatter]);var G=x.line().curve(x.curveMonotoneX).x(function(av){return ae(av.timestamp)}).y(function(av){return ad(av.value)});var M=x.select("#status-history-chart-container").append("svg").attr("style","pointer-events: none;").attr("width",N.parent().width()).attr("height",N.innerHeight());var H=M.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",z).attr("height",A);var au=M.append("g").attr("transform","translate("+E.left+", "+E.top+")");var D=x.min(ar,function(av){return x.min(av.values,function(aw){return aw.timestamp})});var K=x.max(ar,function(av){return x.max(av.values,function(aw){return aw.timestamp})});i(C,"Start",h.formatDateTime(D));i(C,"End",h.formatDateTime(K));ae.domain([D,K]);ad.domain([p(ar),t(ar)]);au.append("g").attr("class","x axis").attr("transform","translate(0, "+A+")").call(U);au.append("g").attr("class","y axis").call(F).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").attr("text-anchor","end").text(ag.label);var ab=au.selectAll(".status").data(ar).enter().append("g").attr("clip-path","url(#clip)").attr("class","status");ab.append("path").attr("class",function(av){return"chart-line chart-line-"+av.id}).attr("d",function(av){return G(av.values)}).attr("stroke",function(av){return X(av.label)}).classed("hidden",function(av){return av.visible===false}).append("title").text(function(av){return av.label});ab.each(function(av){var aw=x.select(this).append("g").attr("class",function(){return"mark-group mark-group-"+av.id}).classed("hidden",function(ax){return ax.visible===false});aw.selectAll("circle.mark").data(av.values).enter().append("circle").attr("style","pointer-events: all;").attr("class","mark").attr("cx",function(ax){return ae(ax.timestamp)}).attr("cy",function(ax){return ad(ax.value)}).attr("fill",function(){return X(av.label)}).attr("r",1.5).append("title").text(function(ax){return av.label+" -- "+v[ag.formatter](ax.value)})});M.attr("width",N.parent().width()).attr("height",N.innerHeight());H.attr("width",z).attr("height",A);au.select(".x.axis").attr("transform","translate(0, "+A+")");var T=e("#status-history-chart-control-container").empty();var R=T.innerHeight()-E.top-E.bottom;var ak=x.scaleTime().range([0,z]);var J=x.axisBottom(ak).ticks(5).tickFormat(O);var ao=x.scaleLinear().range([R,0]);var ai=x.axisLeft(ao).tickValues(ad.domain()).tickFormat(v[ag.formatter]);var Q=x.line().curve(x.curveMonotoneX).x(function(av){return ak(av.timestamp)}).y(function(av){return ao(av.value)});var af=x.select("#status-history-chart-control-container").append("svg").attr("width",N.parent().width()).attr("height",R+E.top+E.bottom);var W=af.append("g").attr("transform","translate("+E.left+", "+E.top+")");ak.domain(ae.domain());ao.domain(ad.domain());W.append("g").attr("class","x axis").attr("transform","translate(0, "+R+")").call(J);W.append("g").attr("class","y axis").call(ai);var at=W.selectAll(".status").data(ar).enter().append("g").attr("class","status");at.append("path").attr("class",function(av){return"chart-line chart-line-"+av.id}).attr("d",function(av){return Q(av.values)}).attr("stroke",function(av){return X(av.label)}).classed("hidden",function(av){return d[av.id]===false}).append("title").text(function(av){return av.label});var L=function(){var aA=e.map(ar,function(aG){var aE=ae.domain();var aF=ad.domain();var aH=e.extend({},aG);return e.extend(aH,{values:e.grep(aG.values,function(aI){return aI.timestamp.getTime()>=aE[0].getTime()&&aI.timestamp.getTime()<=aE[1].getTime()&&aI.value>=aF[0]&&aI.value<=aF[1]})})});var av=e.grep(aA,function(aE){return aE.id!==w.nifiInstanceId&&aE.visible&&aE.values.length>0});var az=av.length===0?"NA":v[ag.formatter](p(av));var ay=av.length===0?"NA":v[ag.formatter](f(av));var aw=av.length===0?"NA":v[ag.formatter](t(av));e("#node-aggregate-statistics").text(az+" / "+aw+" / "+ay);var aC=e.grep(aA,function(aE){return aE.id===w.nifiInstanceId&&aE.visible&&aE.values.length>0});var aD=aC.length===0?"NA":v[ag.formatter](p(aC));var aB=aC.length===0?"NA":v[ag.formatter](f(aC));var ax=aC.length===0?"NA":v[ag.formatter](t(aC));e("#cluster-aggregate-statistics").text(aD+" / "+ax+" / "+aB)};var aq=function(av,aw){ae.domain(av);ad.domain(aw);ab.selectAll(".chart-line").attr("d",function(ax){return G(ax.values)});ab.selectAll("circle.mark").attr("cx",function(ax){return ae(ax.timestamp)}).attr("cy",function(ax){return ad(ax.value)}).attr("r",function(){return x.brushSelection(P.node())===null?1.5:4});au.select(".x.axis").call(U);au.select(".y.axis").call(F)};var I=function(){c=x.brushSelection(P.node());var aw,av;if(c===null){var ax=e.grep(ar,function(ay){return ay.visible});if(ax.length===0){av=ao.domain()}else{av=[x.min(ax,function(ay){return x.min(ay.values,function(az){return az.value})}),x.max(ax,function(ay){return x.max(ay.values,function(az){return az.value})})]}aw=ak.domain()}else{aw=[c[0][0],c[1][0]].map(ak.invert,ak);av=[c[1][1],c[0][1]].map(ao.invert,ao)}aq(aw,av);L()};var al=x.brush().extent([[ak.range()[0],ao.range()[1]],[ak.range()[1],ao.range()[0]]]).on("brush",I);var P=W.append("g").attr("class","brush").on("click",I).call(al);if(h.isDefinedAndNotNull(c)){al=al.move(P,c)}W.select("rect.selection").attr("style","pointer-events: all;").on("dblclick",function(){if(c!==null){var av=ao.range();al.move(P,[[c[0][0],av[1]],[c[1][0],av[0]]])}});var ac=e.grep(ar,function(av){return av.id!==w.nifiInstanceId}).sort(function(aw,av){return aw.label<av.label?-1:aw.label>av.label?1:0});var ap=function(aw,av){var ay=e("<div></div>").addClass("legend-label nf-checkbox-label").css("color",X(av.label)).text(av.label).ellipsis();var ax=e('<div class="nf-checkbox"></div>').on("click",function(){var az=x.selectAll("path.chart-line-"+av.id);var aB=x.select("g.mark-group-"+av.id);var aA=aB.classed("hidden");az.classed("hidden",function(){return !aA});aB.classed("hidden",function(){return !aA});av.visible=aA;d[av.id]=av.visible;I()}).addClass(av.visible?"checkbox-checked":"checkbox-unchecked");e('<div class="legend-entry"></div>').append(ax).append(ay).on("mouseenter",function(){x.selectAll("path.chart-line-"+av.id).classed("over",true)}).on("mouseleave",function(){x.selectAll("path.chart-line-"+av.id).classed("over",false)}).appendTo(aw)};var Z=e.grep(ar,function(av){return av.id===w.nifiInstanceId});var aj=o("NiFi");i(aj,"Min / Max / Mean","","cluster-aggregate-statistics");ap(aj,Z[0]);if(ac.length>0){var Y=o("Nodes");i(Y,"Min / Max / Mean","","node-aggregate-statistics");e.each(ac,function(aw,av){ap(Y,av)})}I();var V,am,S,an;N.append('<div class="ui-resizable-handle ui-resizable-se"></div>').resizable({minWidth:425,minHeight:150,handles:{se:".ui-resizable-se"},resize:function(ax,aw){an=e("#status-history-dialog");var av={};if(h.isDefinedAndNotNull(an.data("nf-dialog"))){av=an.data("nf-dialog")}av["min-width"]=(an.width()/e(window).width())*100+"%";av["min-height"]=(an.height()/e(window).height())*100+"%";av.responsive["fullscreen-width"]=an.outerWidth()+"px";av.responsive["fullscreen-height"]=an.outerHeight()+"px";V=u();if(aw.helper.width()>V){aw.helper.width(V);av.responsive["fullscreen-width"]=e(window).width()+"px";av["min-width"]="100%"}am=y();if(aw.helper.height()>am){aw.helper.height(am);av.responsive["fullscreen-height"]=e(window).height()+"px";av["min-height"]="100%"}S=a();if(aw.helper.height()<S){aw.helper.height(S)}av["min-width"]=(parseInt(av["min-width"],10)>=100)?"100%":av["min-width"];av["min-height"]=(parseInt(av["min-height"],10)>=100)?"100%":av["min-height"];an.data("nfDialog",av);an.css("min-width",(N.outerWidth()+e("#status-history-details").outerWidth()+40));an.css("min-height",(N.outerHeight()+e("#status-history-refresh-container").outerHeight()+e("#status-history-chart-control-container").outerHeight()+e(".dialog-buttons").outerHeight()+e(".dialog-header").outerHeight()+40+5));an.center()},stop:l})}};var p=function(z){return x.min(z,function(A){return x.min(A.values,function(B){return B.value})})};var t=function(z){return x.max(z,function(A){return x.max(A.values,function(B){return B.value})})};var f=function(A){var B=0;var z=x.sum(A,function(C){B+=C.values.length;return x.sum(C.values,function(D){return D.value})});return z/B};var o=function(A){var z=e('<div class="status-history-detail"></div>').appendTo("#status-history-details");e('<div class="detail-container-label"></div>').text(A).appendTo(z);return e("<div></div>").appendTo(z)};var i=function(A,C,D,E){var B=e('<div class="detail-item"></div>').appendTo(A);e('<div class="setting-name"></div>').text(C).appendTo(B);var z=e('<div class="setting-field"></div>').text(D).appendTo(B);if(h.isDefinedAndNotNull(E)){z.attr("id",E)}};var b={init:function(z){n=z;e("#status-history-refresh-button").click(function(){var A=e("#status-history-dialog").data("status-history");if(A!==null){if(A.type===w.type.processor){b.showProcessorChart(A.groupId,A.id,A.selectedDescriptor)}else{if(A.type===w.type.processGroup){b.showProcessGroupChart(A.groupId,A.id,A.selectedDescriptor)}else{if(A.type===w.type.remoteProcessGroup){b.showRemoteProcessGroupChart(A.groupId,A.id,A.selectedDescriptor)}else{b.showConnectionChart(A.groupId,A.id,A.selectedDescriptor)}}}}});e("#status-history-dialog").modal({scrollableContentStyle:"scrollable",headerText:"Status History",buttons:[{buttonText:"Close",color:{base:"#728E9B",hover:"#004849",text:"#ffffff"},handler:{click:function(){this.modal("hide")}}}],handler:{close:function(){e("#status-history-dialog").removeData("status-history");e("#status-history-chart-container").empty();e("#status-history-chart-control-container").empty();e("#status-history-details").empty();c=null;q=null;d=null},open:l}});e(window).on("resize",function(A){if(A.target===window){l()}h.toggleScrollable(e("#status-history-details").get(0))})},showConnectionChart:function(z,A,B){e.ajax({type:"GET",url:w.urls.api+"/flow/connections/"+encodeURIComponent(A)+"/status/history",dataType:"json"}).done(function(C){k(z,A,C.statusHistory,w.type.connection,B)}).fail(g.handleAjaxError)},showProcessorChart:function(z,B,A){e.ajax({type:"GET",url:w.urls.api+"/flow/processors/"+encodeURIComponent(B)+"/status/history",dataType:"json"}).done(function(C){k(z,B,C.statusHistory,w.type.processor,A)}).fail(g.handleAjaxError)},showProcessGroupChart:function(A,z,B){e.ajax({type:"GET",url:w.urls.api+"/flow/process-groups/"+encodeURIComponent(z)+"/status/history",dataType:"json"}).done(function(C){k(A,z,C.statusHistory,w.type.processGroup,B)}).fail(g.handleAjaxError)},showRemoteProcessGroupChart:function(A,z,B){e.ajax({type:"GET",url:w.urls.api+"/flow/remote-process-groups/"+encodeURIComponent(z)+"/status/history",dataType:"json"}).done(function(C){k(A,z,C.statusHistory,w.type.remoteProcessGroup,B)}).fail(g.handleAjaxError)}};return b}));